<!DOCTYPE html>
<html>

  <head>
	<meta name="generator" content="Hugo 0.91.2" />

  <title>
      
      ScottW/rites
      
  </title>

</head>


  <body>

    

	
<div class="h-feed">

	
	
	  <div class="h-entry">
		
			<h1><a href="https://scottw.com/2024/02/20/lessons-learned-migrating.html"> 11 Lessons Learned Migrating HowIVSCode to Rails 7.1</a></h1>
		

		<a href="https://scottw.com/2024/02/20/lessons-learned-migrating.html" class="u-url"><time class="dt-published" datetime="2024-02-20 09:30:04 -0500">Feb 20, 2024</time></a>

		<div class="e-content">
			 <p>For reasons I will share in another post, I was forced to move two personal projects off of Heroku and onto HatchBox. The first, ThocStock, went very smoothly. I deployed the code, set a couple of ENVs, verified everything worked as expected, and finally updated the DNS.</p>
<p>The second app, HowIVSCode, proved to be a bit more of a challenge. The first commits were about 4.5 years ago. Like many side projects with no revenue, apart from some gem security updates, it has not seen many changes over the last four years.</p>
<p>The app was primarily built on Rails 5, TailwindCSS, webpacker, Administrate, and Delayed Job. Deploying to HatchBox yielded errors related to Python via Webpacker and led me down the trail of ripping out Webpacker, CSS building, and JS bundling. After a while, it felt like I was running in circles, putting out new small fires. All solvable problems, but then it hit me. This app has a total of 3 models and a couple of controllers. There is little value in maintaining the source history (and I still have it if needed).</p>
<p>I wanted to try out LiteStack, so I told myself I could do this in an hour or two if I started from scratch and copied over the models, controllers, and views.</p>
<p>In typical developer fashion, 2 hours was not a realistic estimate (probably closer to 6 to 8), but I learned quite a bit along the way.</p>
<p>So here is what I learned upgrading a mostly kludgy Rails 5/webpacker app to a fresh Rails 7.1 app using LiteStack + ImportMaps + Avo.</p>
<p><strong>NOTE:</strong> <em>I call this a migration instead of an upgrade because I am starting mostly fresh and pulling in the relevant pre-existing parts.</em></p>
<h2 id="running-rails-new-with-the---skip-bundle-flag-has-potentially-unintended-consequences">Running Rails New with the &ndash;skip-bundle flag Has Potentially Unintended Consequences</h2>
<p>I had initially <a href="https://twitter.com/scottw/status/1756387596220129283">mentioned on X</a> that using import maps required I execute the following on my own.</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">bin/rails importmap:install tailwindcss:install stimulus:install:importmap turbo::install:importmap
</code></pre></td></tr></table>
</div>
</div><p>This is something I would have expected Rails to just do based on the flags I had set when running new (and primarily based upon what was in my .railsrc)</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">--css=tailwind
--javascript=importmap
--database=sqlite3
--asset-pipeline=propshaft
--template=~/rails_template.rb
--skip-jbuilder
--skip-bundle
</code></pre></td></tr></table>
</div>
</div><p>While writing this, I conducted several tests and discovered a few issues that may be bugs or inadequacies in the documentation. When using the &ndash;skip-bundle flag, the proper installation of Importmap, Tailwind, Stimulus, and Turbo is not facilitated. This might seem logical since installing them without bundling is challenging. However, I would have expected running the bundle manually later (or perhaps bin/setup) would resolve this issue.</p>
<p>It also appears that with the <code>--skip-bundle</code> flag, the Tailwind-Rails gem is not included when specified with the &ndash;css=tailwind flag.</p>
<p>Again, there is some chicken and egg here. It is on my list to dig into the source more to figure this out. But you will likely be up and running quicker if you do not use the skip-bundle flag.</p>
<h2 id="importmap-limitations">ImportMap Limitations</h2>
<p>The short answer here is that everything you typically bundle with JavaScript is always an option (today) with importmaps. This is something to consider beforehand, especially if you have a list of JavaScript libraries you need to use. In the case of HowIVSCode, I could not experiment with DaisyUI. However, the long-term benefit of an app that will not get many updates is too good to ignore.</p>
<h2 id="omniauth-login-links-likely-require-an-http-post">OmniAuth Login &lsquo;Links&rsquo; (Likely) Require an HTTP Post</h2>
<p>The only way to log in or create an account with HowIVSCode is via GitHub + OAuth. OmniAuth now recommends adding the gem <code>omniauth-rails_csrf_protection</code>. I didn&rsquo;t think much about it and just added it.</p>
<p>However, once in place, you can no longer use a href as part of your sign-up flow. The reasoning for this makes sense, but in quickly trying to move to the most recent gem updates, I spun my tires here for far longer than I care to admit.</p>
<h2 id="no-arrays-in-sqlite">No Arrays in SQLite</h2>
<p>When relational data is small and often just a word or two, I use an array in PostgreSQL.</p>
<p>For example, a migration for a small blog post table might look like this:</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">create_table <span style="color:#ed9d13">:posts</span> <span style="color:#6ab825;font-weight:bold">do</span> |t|
	t.text <span style="color:#ed9d13">:title</span>
	t.text <span style="color:#ed9d13">:body</span>
	t.text <span style="color:#ed9d13">:tags</span>, <span style="color:#ed9d13">array</span>: <span style="color:#6ab825">true</span>
<span style="color:#6ab825;font-weight:bold">end</span>
</code></pre></td></tr></table>
</div>
</div><p>I no longer need a separate <code>tags</code> table or a <code>tags_in_posts</code> related table. PostgreSQL provides the necessary functions to query this as needed.</p>
<p>Unfortunately, there are no Arrays in SQLite. However, all is not lost. SQLite does support JSON, so for now, I added a json column called data and the necessary arrays. This is just data I am recording, so we will have to see in the future if this holds up when querying by specific tags becomes necessary.</p>
<h2 id="apply-warnings">@apply warnings</h2>
<p>For better or worse, I occasionally use @apply with my Tailwind CSS. VSCode kept complaining about (although it still worked) an <code>Unknown Rule</code>. The fix is to set the *.css file association to <code>tailwindcss</code>. Full details <a href="https://cssf1.com/how-to/fix-unknown-at-rule-tailwind-warning-vscode">here</a>.</p>
<h2 id="default-layout-for-sitepress">Default Layout for SitePress</h2>
<p>My markdown content views previously used the markdown-views gem. This time around, I decided to go with SitePress. Overall, SitePress has been great to work with. However, one thing I struggled with was how to use a different layout for my content pages.</p>
<p>With my SitePress pages, everything that is not the markdown body is set in a different Layout file. This way, I did not have to try and overly mix Markdown and ERB in my content (and as far as I can tell, you cannot even access SitePress&rsquo;s page variables</p>
<p>I tried various ways to make this work, but I settled on creating a new controller derived from Sitepress::SiteController. Then, in my routes file, I specified that this controller would be used <code>sitepress_pages(controller: &quot;content&quot;)</code> for my pages.</p>
<h2 id="meta-tags-with-sitepress">Meta Tags with SitePress</h2>
<p>Similar to the above concern, I wanted to be still able to set various meta tags via the meta-tags gem.</p>
<p>Again, trying to avoid any ERB in my Markdown as much as possible, I added a meta section to my frontmatter and wired it up like this in the SitePress layout.</p>
<h2 id="markdown-escaping-in-sitepress">Markdown Escaping in SitePress</h2>
<p>I have a Stimulus controller that adds your API key to the clipboard when you click on it. Previously, I rendered a partial which wired up the controller <code>&lt;%= render partial: &quot;auth_token&quot; %&gt;</code></p>
<p>The partial approach still worked (I know, ERB in MD), but the <code>#</code> in  <code>data-action=&quot;click-&gt;copy-auth-key#copy</code> is causing RedCarpret (SitePress&rsquo;s markdown processer) to start escaping everything after. The markdown-views gem uses Commonmarker for processing markdown and doesn&rsquo;t appear to have this issue (I have tests to compare if someone is interested).</p>
<p>If I were using more stimulus in the project, I would probably need to dig deeper and/or swap Markdown libraries. My usage was simple enough; I just dropped the data-action attribute and wired up an event listener in my controller.</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#6ab825;font-weight:bold">import</span> { Controller } from <span style="color:#ed9d13">&#34;@hotwired/stimulus&#34;</span>;
<span style="color:#6ab825;font-weight:bold">export</span> <span style="color:#6ab825;font-weight:bold">default</span> <span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#6ab825;font-weight:bold">extends</span> Controller {
  copy() {
    navigator.clipboard.writeText(<span style="color:#6ab825;font-weight:bold">this</span>.element.innerText.trim());
  }
  initialize() {
    <span style="color:#6ab825;font-weight:bold">this</span>.element.addEventListener(<span style="color:#ed9d13">&#34;click&#34;</span>, <span style="color:#6ab825;font-weight:bold">this</span>.copy.bind(<span style="color:#6ab825;font-weight:bold">this</span>))
  }
}
</code></pre></td></tr></table>
</div>
</div><p>Sometimes, being lazy is the correct answer.</p>
<h2 id="importing-data-from-pg-to-sqlite">Importing Data from PG to Sqlite</h2>
<p>Sadly, there does not appear to be an easy off-the-self option to go in this direction. Most articles recommended doing a pg_dump to SQL and then massaging the file to work with Sqlite. Depending on the data complexity, this might be your best option. I was going from the old to the new app with roughly the same ActiveRecord models (minus the arrays).</p>
<p>I found generating a couple of JSON files from the original app and then looping over each of them with my new models to be the simplest repeatable option.</p>
<h2 id="configuring-where-litestack-puts-the-sqlite-databases-in-production">Configuring Where LiteStack Puts The SQLite Databases in Production</h2>
<p>Hatchbox provides each app with a persistent storage location. Using the database.yml, it is simple to set this as the folder for your data.sqlite3 file. However, I wanted to be sure that the other Sqlite databases, such as queue.sqlite3, are also correctly persisted. For the litequeue.yml, there is a db path option, but this is relative to the main app configuration.</p>
<p>Looking at the LiteStack docs, there was no obvious answer. However, digging through the source, there is an ENV variable you can set: <code>LITESTACK_DATA_PATH</code></p>
<p>The benefit of the ENV is it also handles the data.sqlite3 file as well, so I could remove the hardcoded production path from my database.yml.</p>
<p>Side note: It still sticks the files in a production sub-directory. It is not the end of the world, but I hope it becomes optional.</p>
<h2 id="bundle-only-supports-arm64-darwin">Bundle Only Supports &ldquo;arm64-darwin&rdquo;</h2>
<p>I believe this is related to the non-bundle issue I had previously. Essentially, my bundle was only valid as is for M1 Macs.</p>
<p>The fix was as easy as <code>bundle lock --add-platform x86_64_linux</code></p>
<p>If you watch the output from a <code>rails new</code> without the <code>--skip-bundle</code> flag, you can see the <code>--add-platform</code> flag is set.</p>

		</div>
	  </div>
	
	  <div class="h-entry">
		
			<h1><a href="https://scottw.com/2024/02/14/http-post-with.html">HTTP Post with a Link_To in Rails 7</a></h1>
		

		<a href="https://scottw.com/2024/02/14/http-post-with.html" class="u-url"><time class="dt-published" datetime="2024-02-14 06:58:07 -0500">Feb 14, 2024</time></a>

		<div class="e-content">
			 <p>I have been migrating a small app to Rails 7.x. The app has not been touched in a couple of years (Rails 5-ish with webpacker). I decided it would be simpler to start anew and just copy over the parts I needed.</p>
<p>One thing I noticed on a new app without RJS installed was that setting the HTTP method on links was not working.</p>
<p>There are two ways to fix this. One is to just use <code>button_to</code> instead. This is arguably better since it actually does a POST (and submit). However, if you need/want to continue using <code>link_to</code>, you can instead swap the <code>method</code> for a <code>turbo_method</code>.</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">&lt;li&gt;
  &lt;%= link_to &#34;Sign Out&#34;, logout_path, data: {turbo_method: :delete}, aria: {label: &#34;Sign out of How I VSCode&#34;}, class: &#34;nav-link&#34; %&gt;
&lt;/li&gt;
</code></pre></td></tr></table>
</div>
</div>
		</div>
	  </div>
	
	  <div class="h-entry">
		
			<h1><a href="https://scottw.com/2024/01/31/enabling-debugging-in.html">Enabling Debugging in Campfire</a></h1>
		

		<a href="https://scottw.com/2024/01/31/enabling-debugging-in.html" class="u-url"><time class="dt-published" datetime="2024-01-31 15:31:25 -0500">Jan 31, 2024</time></a>

		<div class="e-content">
			 <p>Ruby&rsquo;s debugging story has improved dramatically in 3.x (and Rails).</p>
<p>I figured the best way to understand what&rsquo;s happening in Campfire would be to attach the debugger and step through some of the more interesting parts.</p>
<p>Unfortunately, I was greeted with a recurring error that often looked something like this:</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">&lt;Thread:0x00000001276a7750@DEBUGGER__::Server::reader /Users/scott/.asdf/installs/ruby/3.3.0/lib/ruby/gems/3.3.0/gems/debug-1.9.1/lib/debug/server.rb:44 aborting&gt; terminated with exception (report_on_exception is true):
/Users/scott/.asdf/installs/ruby/3.3.0/lib/ruby/3.3.0/socket.rb:1128:in `unlink&#39;: No such file or directory @ apply2files - /var/folders/6q/xz6r4tqd4sl9qpbqkjlqj3dr0000gn/T/rdbg-501/rdbg-29191 (Errno::ENOENT)
	from /Users/scott/.asdf/installs/ruby/3.3.0/lib/ruby/3.3.0/socket.rb:1128:in `ensure in unix_server_socket&#39;
/Users/scott/.asdf/installs/ruby/3.3.0/lib/ruby/3.3.0/socket.rb:1128:in `unlink&#39;	from /Users/scott/.asdf/installs/ruby/3.3.0/lib/ruby/3.3.0/socket.rb:1128:in `unix_server_socket&#39;
	from /Users/scott/.asdf/installs/ruby/3.3.0/lib/ruby/3.3.0/socket.rb:1169:in `unix_server_loop&#39;
	from /Users/scott/.asdf/installs/ruby/3.3.0/lib/ruby/gems/3.3.0/gems/debug-1.9.1/lib/debug/server.rb:502:in `accept&#39;
	from /Users/scott/.asdf/installs/ruby/3.3.0/lib/ruby/gems/3.3.0/gems/debug-1.9.1/lib/debug/server.rb:49:in `block in activate&#39;
</code></pre></td></tr></table>
</div>
</div><p>At first, I was convinced that debugging was busted on my computer. But I spun up a new project, and everything worked as expected.</p>
<p>Then, I thought about the error above showing up multiple times and the <a href="https://scottw.com/2024/01/30/getting-campfire-to.html">problems with threads I had previously</a> mentioned.</p>
<p>I restarted the process without cluster mode enabled for Puma (WEB_CONCURRENCY=0) and could connect the debugger as expected.</p>
<p>From here, I decided to compare the puma.rb file in Campfire to the one in the empty Rails 7.1 project I just spun up, and I found the problem.</p>
<p>In the Puma configuration file, cluster mode is enabled if <code>workers</code> is greater than 0.</p>
<p>In a fresh Rails 7.1 puma.rb file, the worker configuration looks like this:</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#6ab825;font-weight:bold">if</span> <span style="color:#40ffff">ENV</span>[<span style="color:#ed9d13">&#34;RAILS_ENV&#34;</span>] == <span style="color:#ed9d13">&#34;production&#34;</span>
  <span style="color:#24909d">require</span> <span style="color:#ed9d13">&#34;concurrent-ruby&#34;</span>
  worker_count = <span style="color:#24909d">Integer</span>(<span style="color:#40ffff">ENV</span>.fetch(<span style="color:#ed9d13">&#34;WEB_CONCURRENCY&#34;</span>) { <span style="color:#40ffff">Concurrent</span>.physical_processor_count })
  workers worker_count <span style="color:#6ab825;font-weight:bold">if</span> worker_count &gt; <span style="color:#3677a9">1</span>
<span style="color:#6ab825;font-weight:bold">end</span>
</code></pre></td></tr></table>
</div>
</div><p>However, in Campfire, the RAILS_ENV check is removed</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">worker_count = (Concurrent.processor_count * 0.666).ceil
workers ENV.fetch(&#34;WEB_CONCURRENCY&#34;) { worker_count }
</code></pre></td></tr></table>
</div>
</div><p>My guess is that with Campfire being a chat app with lots of connectivity, they opted for Puma&rsquo;s cluster mode by default.</p>
<p>The good news is you can disable cluster mode in Campfire without changing any source. Just set the WEB_CONCURRENCY ENV to 0.</p>
<p>Something like this should do the trick:</p>
<p><code>WEB_CONCURRENCY=0 rdbg -n --open=vscode -c -- bin/rails server -p 3000</code></p>

		</div>
	  </div>
	
	  <div class="h-entry">
		
			<h1><a href="https://scottw.com/2024/01/30/getting-campfire-to.html">Setting Up Campfire on Localhost</a></h1>
		

		<a href="https://scottw.com/2024/01/30/getting-campfire-to.html" class="u-url"><time class="dt-published" datetime="2024-01-30 14:14:31 -0500">Jan 30, 2024</time></a>

		<div class="e-content">
			 <p>David Kimura at <a href="https://www.driftingruby.com/episodes?tag=campfire">Drifting Ruby</a> has some good videos on setting Campfire up outside the Once installer.  Outside of the 3.3 RC1 and stringio issues, I was running into another issue: I could not generate thumbnails when running on localhost. The thumbnails generated as expected when using Puma Dev. Still, on localhost, they were failing, and worse, I would typically end up with one broken thumbnail variant per thread pool worker.</p>
<p>First, here are my setup steps:</p>
<ol>
<li>Download the source</li>
<li>Run bin/setup (I had to remove rbenv from this file since I use ASDF these days)</li>
<li>From the rails console, run, <code>WebPush.generate_key</code> and copy the keys into ENV variables <code>VAPID_PUBLIC_KEY</code> and <code>VAPID_PRIVATE_KEY</code></li>
<li>Add the <code>msgpack</code> gem to my GemFile</li>
</ol>
<p>With all of this in place, <a href="https://campfire.test">https://campfire.test</a> worked as expected.</p>
<p>However, when starting the server via <code>bundle exec rails server</code> (on an M1 MBP with Sonoma 14.3), the thumbnails of images were missing. I could click on the thumbnails and see them in the lightbox but not in the chat window.</p>
<p>Digging into the database, I could see they were not being analyzed, but I had no idea why.</p>
<p>Then I saw the following in the logs:</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">objc[84578]: +[__NSCFConstantString initialize] may have been in progress in another thread when fork() was called.
objc[84578]: +[__NSCFConstantString initialize] may have been in progress in another thread when fork() was called. We cannot safely call it or ignore it in the fork() child process. Crashing instead. Set a breakpoint on objc_initializeAfterForkError to debug.
</code></pre></td></tr></table>
</div>
</div><p>The thread running ActiveJob running the ActiveStorage Analyze job was crashing.</p>
<p>A little searching led me to this <a href="https://github.com/rails/rails/issues/38560">bug thread</a> and a suggestion to set <code>OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES</code>. A quick server reboot, and everything works as expected.</p>
<p>Before I got here, I also tried disabling cluster mode in Puma, <code>WEB_CONCURRENCY=0 bundle exec rails s</code>, which solved the problem.</p>
<p>I submitted this as a bug to 37Signals. I am not sure if this is just something on my computer or not, so I would try it without these changes first.</p>
<p><strong>Update:</strong> 37Signals confirmed this is a known issue. The env variable is actually set in the <code>.pumadev</code> file which is why I did. not see the issue when using Puma Dev.</p>

		</div>
	  </div>
	
	  <div class="h-entry">
		
			<h1><a href="https://scottw.com/2024/01/18/a-few-new.html">A few new apps I am using in 2024</a></h1>
		

		<a href="https://scottw.com/2024/01/18/a-few-new.html" class="u-url"><time class="dt-published" datetime="2024-01-18 09:20:09 -0500">Jan 18, 2024</time></a>

		<div class="e-content">
			 <p><a href="https://typefully.com/?via=scott">Typefully</a> - a few options exist for posting to social media without logging in first. I am trying to get back into writing/sharing, and this seems like the best option.</p>
<p>If Threads adds an API, all will be right.</p>
<p><a href="https://cronometer.com">Cronometer</a> - A replacement for MyFitnessPal. Short review: It is better in every way.  It is easier to use, quicker and costs less.</p>
<p>I don&rsquo;t track calories as much these days; with a change in my diet recently, I wanted to be a little more diligent.</p>
<p><a href="https://www.craft.do">Craft</a> is a notes app similar to Notion, but I find it more responsive and easier to use. Craft syncs across all my devices and has been a joy for the last few weeks.</p>
<p>Via X: <a href="https://twitter.com/scottw/status/1744751689666818462">twitter.com/scottw/st&hellip;</a></p>

		</div>
	  </div>
	
	  <div class="h-entry">
		
			<h1><a href="https://scottw.com/2024/01/18/the-hidden-month.html">The Hidden Month</a></h1>
		

		<a href="https://scottw.com/2024/01/18/the-hidden-month.html" class="u-url"><time class="dt-published" datetime="2024-01-18 09:14:41 -0500">Jan 18, 2024</time></a>

		<div class="e-content">
			 <p>New Year, new ambitions: start your own business and take control of your time and finances.</p>
<p>But here&rsquo;s the harsh reality: the adrenaline fades, and most give up within weeks.</p>
<p>Here&rsquo;s a suggestion&hellip;</p>
<p>Dedicate your weekends this year. Spend four hours each on Saturday and Sunday building your business.</p>
<p>That&rsquo;s a solid month (26 days) of focused work without sacrificing sleep or your regular schedule.</p>
<p>Speed to market is overrated. Success comes from execution and continuous improvement, week after week, month after month.</p>
<p>Posted initially to X: <a href="https://twitter.com/scottw/status/1745104752818766318">twitter.com/scottw/st&hellip;</a></p>

		</div>
	  </div>
	
	  <div class="h-entry">
		
			<h1><a href="https://scottw.com/2024/01/08/troubleshooting-broken-software.html">Troubleshooting Broken Software Tools Still Sucks</a></h1>
		

		<a href="https://scottw.com/2024/01/08/troubleshooting-broken-software.html" class="u-url"><time class="dt-published" datetime="2024-01-08 11:12:33 -0500">Jan 8, 2024</time></a>

		<div class="e-content">
			 <p>20+ years of professionally building software, and here is how my last hour or so went.</p>
<p><code>heroku login</code> -&gt; <code>zsh: killed heroku login</code></p>
<p>hmmm&hellip;why did ZSH kill Heroku? It turns out it is just reporting what happened.</p>
<p>Open the crash reports and get a bunch of text I barely understand.</p>
<p>I remember that I have a second brain that knows what this crap means. <strong>ChatGPT, can you help me?</strong></p>
<p>It does a decent job of educating me on what the reports (segfault on the main thread implies not even the hand of God can save this process).</p>
<p>When in doubt, just re-install.</p>
<p>No dice.</p>
<p>Google shows me others with similar problems, but none related to Heroku, and nothing that looks promising.</p>
<p>I wonder what the <strong>(brew) Doctor</strong> thinks about this (Heroku was installed this way).</p>
<p>The doctor takes her good old time getting back to me on this older Mac. But when she does respond, she says, &ldquo;Dawg, your shit is F&rsquo;ed Up!&rdquo;</p>
<p>I am paraphrasing, but there are unlinked things, kegs with no formula,, dry taps, an unbrewed dylibs, and likely most importantly, this:</p>
<!-- raw HTML omitted -->
<p>This is weird because I had previously checked for an update after an OS update, and I had tried to re-install the tools just to be safe.</p>
<p>In both cases, it said, &ldquo;there are no updates, go away&rdquo;.</p>
<p>Anywho, I run the following:</p>
<p><code>sudo rm -rf /Library/Developer/CommandLineTools</code></p>
<p><code>sudo xcode-select --install</code></p>
<p>Eventually, notice the popup window (because why install them from the terminal), click OK to continue, and 10 minutes or so later, we are back in business.</p>
<p>The key takeaways:</p>
<ol>
<li>This shit isn&rsquo;t hard, it just takes patience.</li>
<li>Even those who have done it for a long time still get stuck.</li>
<li>There is nothing wrong with yelling profanities at a computer from the comfort of your basement.</li>
</ol>

		</div>
	  </div>
	
	  <div class="h-entry">
		
			<h1><a href="https://scottw.com/2024/01/08/finding-joy-in.html">Finding Joy in Fitness: The Importance of Enjoying Your Training</a></h1>
		

		<a href="https://scottw.com/2024/01/08/finding-joy-in.html" class="u-url"><time class="dt-published" datetime="2024-01-08 09:40:30 -0500">Jan 8, 2024</time></a>

		<div class="e-content">
			 <p>Last week&rsquo;s early morning gym commutes were far from ideal. One morning, I attempted to leave and discovered I had a dead battery (actually, two dead batteries). Two days later, I had a close encounter with a deer while driving. Temperatures were in the low 30s at best.</p>
<p>However, at approximately 4:35 am on a Monday (today), I found myself not only commuting to the gym again but also feeling quite excited to get to work.
It struck me then that it all comes down to finding the type of training you genuinely enjoy. While there may be exercises considered &ldquo;the best&rdquo; or &ldquo;better,&rdquo; even engaging in the most mediocre exercise is far better for you than doing nothing.</p>
<p>This wasn&rsquo;t always the case for me. It took some trial and error, along with the willingness to start something, fully commit to it, and then be open to finding something that I both enjoyed and that yielded better results.</p>
<p>Ultimately, what truly matters is taking that initial step and sticking with it. It is crucial to listen to your body and determine what it will take to enjoy the work.</p>

		</div>
	  </div>
	

</div>


    
    <script src="https://cdn.usefathom.com/script.js" data-site="VXOVCNBV" defer></script>


  </body>

</html>
